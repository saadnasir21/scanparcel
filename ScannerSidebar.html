<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      #statusMessage { margin-top:8px; font-weight:bold; color:#007500; }
      button { margin-right:4px; }
      .inline { margin-top:6px; }
    </style>
    <script>
      // show a quick non-blocking message
      function showMessage(msg, timeout=300) {
        const div = document.getElementById('statusMessage');
        div.textContent = msg;
        if (timeout) setTimeout(() => div.textContent = '', timeout);
      }

      // scan handler
      function submitScan() {
        const inp = document.getElementById('parcelInput');
        const code = inp.value.trim();
        if (!code) return;

        showMessage('Processingâ€¦', 0);

        google.script.run
          .withSuccessHandler(res => {
            if (res==='Dispatched')       { showMessage('âœ“ Dispatched'); resetInput(); }
            else if (res==='confirmReturn') {
              if (confirm('Marked Dispatched â€” mark as Returned instead?')) {
                google.script.run
                  .withSuccessHandler(r2 => {
                    showMessage(r2==='Returned'? 'â†º Returned' : 'ERR:'+r2);
                    resetInput();
                  })
                  .withFailureHandler(err => showMessage('ERR:'+err.message))
                  .processParcelConfirmReturn(code);
              } else {
                showMessage('âŽ Skipped');
                resetInput();
              }
            }
            else if (res==='confirmDuplicate') {
              const msg = 'Multiple orders for this customer. Dispatch anyway?';
              if (confirm(msg)) {
                google.script.run
                  .withSuccessHandler(r2 => {
                    showMessage(r2==='Dispatched'? 'âœ“ Dispatched' : 'ERR:'+r2);
                    resetInput();
                  })
                  .withFailureHandler(err => showMessage('ERR:'+err.message))
                  .processParcelConfirmDuplicate(code);
              } else {
                showMessage('âŽ Held');
                resetInput();
              }
            }
            else if (res==='WasCancelled') { showMessage('âš ï¸ Order was cancelled'); resetInput(); }
            else if (res==='AlreadyReturned') { showMessage('âš ï¸ Already returned'); resetInput(); }
            else if (res==='NotFound')        { showMessage('âŒ Not found'); resetInput(); }
            else { showMessage('?? '+res); resetInput(); }
          })
          .withFailureHandler(err => {
            showMessage('ERR: '+err.message);
          })
          .processParcelScan(code);
      }

      // undo handler
      function undoScan() {
        google.script.run
          .withSuccessHandler(res=>{
            if (res==='Undone')    showMessage('â†¶ Last scan undone');
            else if (res==='NoAction') showMessage('âš ï¸ Nothing to undo');
            else showMessage('ERR:'+res);
          })
          .undoLastScan();
      }

      function resetInput() {
        var inp = document.getElementById('parcelInput');
        inp.value = '';
        inp.focus();
      }

      function applyStatus() {
        var code   = document.getElementById('parcelInput').value.trim();
        var status = document.getElementById('statusInput').value.trim();
        var date   = document.getElementById('statusDate').value;
        if (!code || !status) return;
        google.script.run.withSuccessHandler(res => {
          var map = {
            'Updated': 'âœ… Status updated',
            'NotFound': 'âŒ Parcel not found',
            'MissingHeaders': 'âš ï¸ Check column headers',
            'WasCancelled': 'âš ï¸ Order was cancelled'
          };
          showMessage(map[res] || res);
          resetInput();
        }).manualSetStatus(code, status, date);
      }

      document.addEventListener('DOMContentLoaded',()=>{
        var inp = document.getElementById('parcelInput');
        inp.focus();
        inp.addEventListener('keyup', e=>{
          if (e.keyCode===13) submitScan();
        });
        var today = new Date().toISOString().substr(0,10);
        document.getElementById('statusDate').value = today;
      });
    </script>
  </head>
  <body>
  <input type="text" id="parcelInput" placeholder="Scan Parcel Here" autofocus style="width:70%">
  <button onclick="submitScan()">Scan</button>
  <button onclick="undoScan()">Undo Last Scan</button>
  <button onclick="cancelManual()">Cancel Order</button>
  <button onclick="cancelByOrderNumber()">Cancel by Order #</button>
  <div class="inline">
    <input id="statusInput" list="statusList" placeholder="Custom Status">
    <datalist id="statusList">
      <option value="Dispatched">
      <option value="Returned">
      <option value="Cancelled by Customer">
    </datalist>
    <input type="date" id="statusDate">
    <button onclick="applyStatus()">Set Status</button>
  </div>
  <div id="statusMessage"></div>

  <script>

    function cancelManual() {
      const code = document.getElementById('parcelInput').value.trim();
      if (!code) return;

      if (!confirm("Are you sure this order was cancelled by customer?")) return;

      google.script.run
        .withSuccessHandler(res => {
          const map = {
            'Cancelled': 'âœ… Cancelled & synced to Shopify',
            'TooLate':   'âš ï¸ Already dispatched/returned',
            'NotFound':  'âŒ Parcel not found',
            'OrderNotFoundOnShopify': 'ðŸ›‘ Shopify order not found',
            'ShopifyFail': 'âŒ Failed to cancel on Shopify',
            'MissingHeaders': 'âš ï¸ Check column headers'
          };
          showMessage(map[res] || res);
          resetInput();
        })
        .withFailureHandler(err => showMessage('ERR:'+err.message))
        .cancelOrderByCustomer(code);
    }

    function cancelByOrderNumber() {
      const code = document.getElementById('parcelInput').value.trim();
      if (!code) return;

      if (!confirm("Are you sure this order was cancelled by customer?")) return;

      google.script.run
        .withSuccessHandler(res => {
          const map = {
            'Cancelled': 'âœ… Cancelled & synced to Shopify',
            'TooLate':   'âš ï¸ Already dispatched/returned',
            'NotFound':  'âŒ Order not found',
            'OrderNotFoundOnShopify': 'ðŸ›‘ Shopify order not found',
            'ShopifyFail': 'âŒ Failed to cancel on Shopify',
            'MissingHeaders': 'âš ï¸ Check column headers'
          };
          showMessage(map[res] || res);
          resetInput();
        })
        .withFailureHandler(err => showMessage('ERR:'+err.message))
        .cancelOrderByNumber(code);
    }
  </script>
</body>

</html>
